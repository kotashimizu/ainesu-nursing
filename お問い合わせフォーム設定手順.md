# お問い合わせフォーム設定手順

## 📋 概要
あいねすの家 訪問看護ステーションのWebサイトにお問い合わせフォームを実装し、フォーム送信時にメール通知を受け取る仕組みを構築しました。

## 🔧 実装内容

### 1. フォーム機能の実装

#### 1.1 HTMLフォームの設定（company.html）
```html
<form class="form form--contact" 
      name="contact" 
      method="POST" 
      data-netlify="true" 
      netlify-honeypot="bot-field" 
      action="/thanks.html">
```

**重要な属性：**
- `name="contact"` - フォームの識別名
- `data-netlify="true"` - Netlify Formsを有効化
- `netlify-honeypot="bot-field"` - スパム対策
- `action="/thanks.html"` - 送信後のリダイレクト先

#### 1.2 送信完了ページ（thanks.html）
フォーム送信後に表示される完了ページを作成。
- 送信成功のビジュアルフィードバック
- 連絡先情報の表示
- トップページへの導線

### 2. Netlify Forms設定

#### 2.1 自動検出
Netlifyは`data-netlify="true"`属性を持つフォームを自動的に検出し、処理します。

#### 2.2 フォームデータの確認
1. [Netlify管理画面](https://app.netlify.com/)にログイン
2. サイトを選択 → Forms
3. 送信されたデータが一覧表示される

### 3. メール通知設定（Google Apps Script）

#### 3.1 Google Apps Scriptプロジェクトの作成

1. **[Google Apps Script](https://script.google.com/)にアクセス**
2. **新しいプロジェクトを作成**
3. **プロジェクト名を設定**：「あいねすの家 フォーム通知」

#### 3.2 スクリプトコードの設置

1. デフォルトのコードを削除
2. `webhook-script.gs`の内容を貼り付け
3. **14行目のメールアドレスを変更**：
```javascript
const NOTIFICATION_EMAIL = 'your-email@example.com'; // ← 実際のメールアドレスに変更
```

#### 3.3 デプロイ手順

1. **デプロイ → 新しいデプロイ**をクリック
2. 以下の設定で公開：
   - **種類**: ウェブアプリ
   - **説明**: Netlifyフォーム通知
   - **実行ユーザー**: 自分
   - **アクセスできるユーザー**: 全員（重要！）
3. **デプロイ**をクリック
4. 初回は承認が必要（Googleアカウントでログイン）
5. **WebアプリのURL**をコピー

#### 3.4 テスト実行

1. エディタで`testWebhook()`関数を選択
2. 実行ボタンをクリック
3. テストメールが届くことを確認

### 4. Netlify Webhook設定

#### 4.1 設定場所
1. [Netlify管理画面](https://app.netlify.com/)にログイン
2. サイトを選択
3. **Site configuration** → **Notifications**
4. **Emails and webhooks** → **Form submission notifications**

#### 4.2 Webhook追加
1. **Add notification**をクリック
2. **Outgoing webhook**を選択
3. 以下を設定：
   - **Event to listen for**: New form submission
   - **URL to notify**: Google Apps ScriptのURL（コピーしたもの）
   - **Form**: contact（または All forms）
4. **Save**をクリック

### 5. 動作確認

#### 5.1 テスト送信
1. Webサイトのお問い合わせフォームにアクセス
2. テストデータを入力して送信
3. thanks.htmlページが表示されることを確認

#### 5.2 通知確認
1. 設定したメールアドレスに通知メールが届くことを確認
2. Netlify管理画面でフォームデータが記録されていることを確認

## 📊 システム構成図

```
利用者がフォーム入力
        ↓
    フォーム送信
        ↓
    Netlify Forms
    （データ保存）
        ↓
    Webhook送信
        ↓
Google Apps Script
    （データ処理）
        ↓
    Gmail送信
        ↓
  管理者にメール通知
```

## 🔍 トラブルシューティング

### メールが届かない場合

1. **Netlifyでの確認**
   - Forms → Verified submissionsにデータがあるか確認

2. **Google Apps Scriptでの確認**
   - 実行数 → ログを確認
   - エラーが記録されていないか確認

3. **よくある原因と対策**

| 問題 | 解決方法 |
|------|---------|
| メールアドレスが未設定 | webhook-script.gsの14行目を確認 |
| Apps Script未承認 | testWebhook()を実行して承認 |
| Webhook URL間違い | 新しいデプロイ後のURLを再設定 |
| 迷惑メールフォルダ | Gmailの迷惑メールを確認 |
| フォーム名の不一致 | HTMLのname属性とNetlify設定を確認 |

### ログの確認方法

**Google Apps Script:**
1. Apps Scriptエディタを開く
2. 左メニュー「実行数」をクリック
3. 実行履歴とログを確認

**Netlify:**
1. Forms → Verified submissions
2. 送信データの詳細を確認

## 📝 メンテナンス

### メールアドレスの変更
1. Google Apps Scriptエディタを開く
2. 14行目の`NOTIFICATION_EMAIL`を変更
3. デプロイ → デプロイを管理 → 編集
4. 新バージョンとしてデプロイ

### 通知内容のカスタマイズ
- `createEmailBody()`関数でテキスト版を編集
- `createHtmlBody()`関数でHTML版を編集

### デバッグモード
問題調査時は17行目を`true`に設定：
```javascript
const DEBUG_MODE = true; // デバッグログを有効化
```

## 💰 コスト
- **Netlify Forms**: 無料プラン内（月100件まで）
- **Google Apps Script**: 完全無料
- **Gmail送信**: 無料（1日の送信制限あり）

## 🔒 セキュリティ
- スパムボット対策（honeypotフィールド）
- フォームデータの自動サニタイズ
- WebhookのHTTPS通信
- Google Apps Scriptの承認制御

## 📚 参考リンク
- [Netlify Forms公式ドキュメント](https://docs.netlify.com/forms/setup/)
- [Google Apps Script公式](https://developers.google.com/apps-script)
- [プロジェクトGitHub](https://github.com/kotashimizu/ainesu-nursing)

## 更新履歴
- 2024年8月28日：初回実装完了
- フォーム機能実装
- メール通知システム構築
- ドキュメント作成

---
作成者：Claude Code Assistant
最終更新：2024年8月28日